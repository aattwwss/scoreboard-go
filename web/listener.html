<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SSE Example</title>
</head>

<body>
	<h1>Server-Sent Events Example</h1>
	<div id="display">00:00</div>
	<div id="events"></div>

	<script>

		let startTime;
		let timerInterval;
		let initialised = false;

		const display = document.getElementById('display');

		function start(timerState) {
			startTime = timerState.startTime;
			timerInterval = setInterval(updateDisplay, 1);
			initialised = true;
		}

		function stop(timerState) {
			clearInterval(timerInterval);
			timerInterval = null;
			display.textContent = timerState.displayTime;
			initialised = true;
		}

		function reset(timerState) {
			clearInterval(timerInterval);
			timerInterval = null;
			display.textContent = '00:00';
			initialised = true;
		}

		function updateDisplay() {
			const elapsedTime = Date.now() - startTime;
			const minutes = Math.floor(elapsedTime / 60000);
			const seconds = Math.floor((elapsedTime % 60000) / 1000);
			const milliseconds = Math.floor((elapsedTime % 1000) / 10);

			const timeString = `${pad(minutes)}:${pad(seconds)}:${pad(milliseconds)}`;
			display.textContent = timeString;
		}

		function pad(number) {
			return number.toString().padStart(2, '0');
		}

		const eventsContainer = document.getElementById('events');
		const urlParams = new URLSearchParams(window.location.search);
		const matchID = urlParams.get('matchID');
		console.log(`matchID: ${matchID}`);

		const eventSource = new EventSource(`http://192.168.1.186:8080/events?matchID=${matchID}`);
		eventSource.onopen = function () {
			console.log('Connection opened');
		};

		eventSource.onmessage = handleDefault;
		eventSource.onerror = function (error) {
			console.log(error);
		};

		eventSource.addEventListener('START', handleStart)
		eventSource.addEventListener('STOP', handleStop)
		eventSource.addEventListener('RESET', handleReset)
		eventSource.addEventListener('INIT', handleInit)

		function handleClose(event) {
			console.log('closed');
			eventSource.close();
		}

		function handleStart(event) {
			start(JSON.parse(event.data));
			console.log(`start: ${event.data}`);
		}

		function handleStop(event) {
			stop(JSON.parse(event.data));
			console.log(`stop: ${event.data}`);
		}

		function handleReset(event) {
			reset(JSON.parse(event.data));
			console.log(`reset: ${event.data}`);
		}

		function handleDefault(event) {
			console.log(`default: ${event.data}`);
		}

		function handleInit(event) {
			if (!initialised) {
				console.log(`init: ${event.data}`);
				let data = JSON.parse(event.data);
				switch (data.action) {
					case 'START':
						start(data);
						break;
					case 'STOP':
						stop(data);
						break;
					case 'RESET':
						reset(data);
						break;
					default:
						console.log("unknown init event");
				}
			}
		}

	</script>
</body>

</html>
